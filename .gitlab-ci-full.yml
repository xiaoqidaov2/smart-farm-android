# GitLab CI/CD 配置文件 - 智慧农场 Android App
stages:
  - build
  - deploy

variables:
  # Android SDK 版本
  ANDROID_COMPILE_SDK: "33"
  ANDROID_BUILD_TOOLS: "33.0.0"
  ANDROID_SDK_TOOLS: "9477386"
  # Python 版本
  PYTHON_VERSION: "3.9"
  # 避免交互式安装
  DEBIAN_FRONTEND: "noninteractive"
  TZ: "Asia/Shanghai"

# 构建 Android APK
build_android:
  stage: build
  image: ubuntu:20.04
  timeout: 2h
  before_script:
    # 设置非交互式环境
    - export DEBIAN_FRONTEND=noninteractive
    - export TZ=Asia/Shanghai
    - ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    
    # 安装系统依赖
    - apt-get update -qq
    - apt-get install -y -qq git wget curl unzip python3 python3-pip python3-venv
    - apt-get install -y -qq build-essential libssl-dev libffi-dev python3-dev
    - apt-get install -y -qq openjdk-11-jdk
    - apt-get install -y -qq autoconf libtool pkg-config zlib1g-dev libncurses5-dev
    - apt-get install -y -qq libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev
    
    # 设置 Java 环境
    - export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
    - export PATH=$PATH:$JAVA_HOME/bin
    
    # 安装 Android SDK
    - wget --quiet --output-document=android-sdk.zip https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip
    - unzip -q android-sdk.zip -d /root/android-sdk-linux
    - export ANDROID_SDK_ROOT=/root/android-sdk-linux
    - export ANDROID_HOME=$ANDROID_SDK_ROOT
    - export PATH=$PATH:${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools
    - mkdir -p ${ANDROID_SDK_ROOT}/cmdline-tools/latest
    - mv ${ANDROID_SDK_ROOT}/cmdline-tools/* ${ANDROID_SDK_ROOT}/cmdline-tools/latest/ || true
    
    # 接受 Android SDK 许可证
    - yes | sdkmanager --licenses >/dev/null 2>&1 || true
    - sdkmanager "platforms;android-${ANDROID_COMPILE_SDK}" "build-tools;${ANDROID_BUILD_TOOLS}"
    
    # 安装 Python 依赖
    - python3 -m pip install --upgrade pip
    - pip3 install buildozer cython
    - pip3 install -r requirements.txt
    
    # 安装 NDK 并设置环境变量
    - sdkmanager "ndk;25.2.9519653"
    - export ANDROID_NDK_ROOT=${ANDROID_SDK_ROOT}/ndk/25.2.9519653
    - export ANDROID_NDK_HOME=${ANDROID_SDK_ROOT}/ndk/25.2.9519653
    - export NDK_ROOT=${ANDROID_SDK_ROOT}/ndk/25.2.9519653
    
    # 创建 buildozer 缓存目录并预设 NDK 路径
    - mkdir -p ~/.buildozer/android/platform
    - ln -sf ${ANDROID_SDK_ROOT}/ndk/25.2.9519653 ~/.buildozer/android/platform/android-ndk-r25c
    
    # 为 buildozer 创建兼容的 SDK 工具路径
    - mkdir -p ${ANDROID_SDK_ROOT}/tools/bin
    - ln -sf ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager ${ANDROID_SDK_ROOT}/tools/bin/sdkmanager
    - ln -sf ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/avdmanager ${ANDROID_SDK_ROOT}/tools/bin/avdmanager
    
  script:
    # 设置 buildozer 配置以允许 root 用户
    - export BUILDOZER_WARN_ON_ROOT=0
    - export ANDROID_SDK_ROOT=/root/android-sdk-linux
    - export ANDROID_HOME=/root/android-sdk-linux
    - export ANDROID_NDK_ROOT=/root/android-sdk-linux/ndk/25.2.9519653
    - export ANDROID_NDK_HOME=/root/android-sdk-linux/ndk/25.2.9519653
    - export NDK_ROOT=/root/android-sdk-linux/ndk/25.2.9519653
    - export PATH=$PATH:/root/android-sdk-linux/cmdline-tools/latest/bin:/root/android-sdk-linux/platform-tools:/root/android-sdk-linux/tools/bin
    
    # 减少构建输出以避免日志截断，但保留错误信息
    - export BUILDOZER_LOG_LEVEL=2
    
    # 确保 NDK 已正确安装
    - ls -la /root/android-sdk-linux/ndk/
    - ls -la /root/android-sdk-linux/ndk/25.2.9519653/ || echo "NDK not found"
    
    # 创建 buildozer 缓存目录结构
    - mkdir -p ~/.buildozer/android/platform
    - mkdir -p ~/.buildozer/android/packages
    
    # 如果 NDK 存在，创建符号链接避免重复下载
    - if [ -d "/root/android-sdk-linux/ndk/25.2.9519653" ]; then
        ln -sf /root/android-sdk-linux/ndk/25.2.9519653 ~/.buildozer/android/platform/android-ndk-r25c;
        echo "NDK symlink created successfully";
      fi
    
    # 设置 buildozer 跳过 NDK 更新检查
    - export BUILDOZER_SKIP_UPDATE=1
    
    # 构建 APK (减少输出详细程度)
    - echo "y" | buildozer android debug -v
    
    # 如果失败，尝试清理并重新构建
    - if [ $? -ne 0 ]; then
        echo "First build failed, cleaning and retrying...";
        buildozer android clean;
        echo "y" | buildozer android debug -v;
      fi
    
    # 检查构建结果
    - ls -la bin/ || echo "No bin directory found"
    - find . -name "*.apk" -type f || echo "No APK files found"
    
  artifacts:
    paths:
      - bin/*.apk
    expire_in: 1 week
    
  cache:
    paths:
      - .buildozer/
      - android-sdk-linux/
    
  only:
    - main
    - develop
    - tags

# 部署到 GitLab Pages (可选)
deploy_pages:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - mkdir public
    - cp bin/*.apk public/ || echo "No APK files found"
    - echo "<html><body><h1>智慧农场 Android App</h1><p><a href='$(ls public/*.apk | head -1)'>下载 APK</a></p></body></html>" > public/index.html
  artifacts:
    paths:
      - public
  only:
    - main
  dependencies:
    - build_android