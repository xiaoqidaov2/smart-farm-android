# GitLab CI/CD 配置文件 - 智慧农场 Android App (优化版)
stages:
  - build

variables:
  ANDROID_COMPILE_SDK: "33"
  ANDROID_BUILD_TOOLS: "33.0.0"
  ANDROID_SDK_TOOLS: "9477386"
  ANDROID_NDK_VERSION: "25.2.9519653"
  PYTHON_VERSION: "3.9"
  DEBIAN_FRONTEND: "noninteractive"

build_android_optimized:
  stage: build
  image: ubuntu:20.04
  timeout: 3h
  
  before_script:
    # 设置环境
    - export DEBIAN_FRONTEND=noninteractive
    - export TZ=Asia/Shanghai
    - ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone
    
    # 更新包管理器
    - apt-get update -qq
    
    # 安装基础依赖 (分批安装以提高稳定性)
    - apt-get install -y -qq wget curl unzip git
    - apt-get install -y -qq python3 python3-pip python3-venv python3-dev
    - apt-get install -y -qq openjdk-11-jdk
    - apt-get install -y -qq build-essential libssl-dev libffi-dev
    - apt-get install -y -qq autoconf libtool pkg-config zlib1g-dev
    - apt-get install -y -qq libncurses5-dev libncursesw5-dev libtinfo5 cmake
    
    # 设置 Java 环境
    - export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
    - export PATH=$PATH:$JAVA_HOME/bin
    - java -version
    
    # 创建 Android SDK 目录
    - mkdir -p /opt/android-sdk
    - cd /opt/android-sdk
    
    # 下载 Android SDK Command Line Tools (使用重试机制)
    - |
      for i in {1..3}; do
        echo "Attempt $i to download Android SDK..."
        if wget --timeout=30 --tries=3 -q https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip -O cmdtools.zip; then
          echo "Download successful"
          break
        else
          echo "Download failed, retrying..."
          sleep 10
        fi
      done
    
    # 解压并设置 SDK
    - unzip -q cmdtools.zip
    - mkdir -p cmdline-tools/latest
    - mv cmdline-tools/* cmdline-tools/latest/ 2>/dev/null || true
    - rm cmdtools.zip
    
    # 设置环境变量
    - export ANDROID_HOME=/opt/android-sdk
    - export ANDROID_SDK_ROOT=/opt/android-sdk
    - export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
    
    # 验证 sdkmanager
    - which sdkmanager
    - sdkmanager --version
    
    # 接受许可证 (使用更可靠的方法)
    - mkdir -p $ANDROID_HOME/licenses
    - echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" > $ANDROID_HOME/licenses/android-sdk-license
    - echo "84831b9409646a918e30573bab4c9c91346d8abd" > $ANDROID_HOME/licenses/android-sdk-preview-license
    
    # 安装 Android 组件 (分步安装)
    - echo "Installing Android platform..."
    - sdkmanager "platforms;android-${ANDROID_COMPILE_SDK}"
    
    - echo "Installing build tools..."
    - sdkmanager "build-tools;${ANDROID_BUILD_TOOLS}"
    
    - echo "Installing NDK..."
    - sdkmanager "ndk;${ANDROID_NDK_VERSION}"
    
    # 设置 NDK 环境变量
    - export ANDROID_NDK_ROOT=$ANDROID_HOME/ndk/${ANDROID_NDK_VERSION}
    - export ANDROID_NDK_HOME=$ANDROID_HOME/ndk/${ANDROID_NDK_VERSION}
    - export NDK_ROOT=$ANDROID_HOME/ndk/${ANDROID_NDK_VERSION}
    
    # 验证安装
    - ls -la $ANDROID_HOME/
    - ls -la $ANDROID_HOME/ndk/
    - ls -la $ANDROID_NDK_ROOT/ || echo "NDK directory not found"
    
    # 返回项目目录
    - cd $CI_PROJECT_DIR
    
    # 安装 Python 依赖
    - python3 --version
    - python3 -m pip install --upgrade pip
    - pip3 install buildozer cython
    - pip3 install -r requirements.txt
    
  script:
    # 设置构建环境变量
    - export ANDROID_HOME=/opt/android-sdk
    - export ANDROID_SDK_ROOT=/opt/android-sdk
    - export ANDROID_NDK_ROOT=/opt/android-sdk/ndk/${ANDROID_NDK_VERSION}
    - export ANDROID_NDK_HOME=/opt/android-sdk/ndk/${ANDROID_NDK_VERSION}
    - export NDK_ROOT=/opt/android-sdk/ndk/${ANDROID_NDK_VERSION}
    - export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools
    - export BUILDOZER_WARN_ON_ROOT=0
    - export BUILDOZER_LOG_LEVEL=2
    
    # 显示环境信息
    - echo "=== Environment Information ==="
    - echo "ANDROID_HOME: $ANDROID_HOME"
    - echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
    - echo "JAVA_HOME: $JAVA_HOME"
    - echo "Python version: $(python3 --version)"
    - echo "Buildozer version: $(buildozer --version)"
    
    # 优化 buildozer.spec (单架构构建)
    - sed -i 's/android.archs = arm64-v8a, armeabi-v7a/android.archs = arm64-v8a/' buildozer.spec
    - sed -i 's/requirements = python3,kivy,kivymd,requests,urllib3,certifi,charset-normalizer,idna/requirements = python3,kivy,kivymd,requests/' buildozer.spec
    
    # 设置 buildozer 使用已安装的 SDK/NDK
    - sed -i "s|android.sdk_path = /root/android-sdk-linux|android.sdk_path = /opt/android-sdk|g" buildozer.spec
    - sed -i "s|android.ndk_path = /root/android-sdk-linux/ndk/25.2.9519653|android.ndk_path = /opt/android-sdk/ndk/${ANDROID_NDK_VERSION}|g" buildozer.spec
    
    # 创建 buildozer 缓存目录
    - mkdir -p ~/.buildozer/android/platform
    - mkdir -p ~/.buildozer/android/packages
    
    # 构建 APK
    - echo "=== Starting APK Build ==="
    - echo "This may take 20-40 minutes..."
    - buildozer android debug -v
    
    # 检查构建结果
    - echo "=== Build Results ==="
    - ls -la bin/ || echo "No bin directory found"
    - find . -name "*.apk" -type f -exec ls -lh {} \; || echo "No APK files found"
    
  artifacts:
    paths:
      - bin/*.apk
    expire_in: 1 week
    when: always
    reports:
      junit: []
    
  cache:
    key: android-build-cache-v3
    paths:
      - .buildozer/
      - /opt/android-sdk/
    policy: pull-push
    
  retry:
    max: 1
    when:
      - runner_system_failure
      - stuck_or_timeout_failure