# GitLab CI/CD 配置文件 for Kivy 移动应用打包

stages:
  - lint
  - build
  - deploy

variables:
  # 定义变量，方便后续使用
  ANDROID_BUILD_OUTPUT: "./.buildozer/android/platform/build-arm64-v8a_armeabi-v7a/dists/myapp__armeabi-v7a__arm64-v8a"
  BUILDOZER_IMAGE: "kivy/buildozer:stable"

# 代码检查作业
lint:
  stage: lint
  image: python:3.12
  before_script:
    - pip install --upgrade pip
    - pip install flake8
    - pip install -r requirements.txt
  script:
    - flake8 --ignore=E501,W503 *.py
  only:
    - branches

# Android 构建作业
android-build:
  stage: build
  image: $BUILDOZER_IMAGE
  before_script:
    # 安装项目依赖
    - pip install --upgrade pip
    - pip install -r requirements.txt
    # 初始化 Buildozer 环境
    - buildozer init
  script:
    # 使用 Buildozer 构建 Android 应用
    - buildozer -v android debug
  artifacts:
    paths:
      # 保存构建产物
      - $ANDROID_BUILD_OUTPUT/myapp-0.1-armeabi-v7a-debug.apk
      - $ANDROID_BUILD_OUTPUT/myapp-0.1-arm64-v8a-debug.apk
    expire_in: 1 week
  only:
    - main
    - tags
  tags:
    - docker

# Android 发布构建作业（仅在标签推送时运行）
android-release:
  stage: build
  image: $BUILDOZER_IMAGE
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - buildozer init
  script:
    # 使用 Buildozer 构建 Android 发布版本
    - buildozer -v android release
  artifacts:
    paths:
      - $ANDROID_BUILD_OUTPUT/myapp-0.1-armeabi-v7a-release.apk
      - $ANDROID_BUILD_OUTPUT/myapp-0.1-arm64-v8a-release.apk
    expire_in: 4 weeks
  only:
    - tags
  tags:
    - docker

# 部署作业示例（可根据实际需求修改）
deploy:
  stage: deploy
  image: alpine:latest
  script:
    - echo "部署应用到指定平台"
    # 这里可以添加实际的部署命令，例如上传到应用商店或内部服务器
  only:
    - tags
  when: manual
