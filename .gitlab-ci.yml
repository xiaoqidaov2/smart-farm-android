# 使用专门的 Kivy Docker 镜像
stages:
  - build

build_with_kivy_docker:
  stage: build
  # 使用官方的 buildozer Docker 镜像
  image: kivy/buildozer:latest
  timeout: 2h
  
  variables:
    BUILDOZER_WARN_ON_ROOT: "0"
  
  before_script:
    # 更新系统和 Python 包
    - apt-get update -qq || true
    - pip install --upgrade pip || true
    - pip install --upgrade buildozer cython || true
    - pip install kivymd requests || true
    
  script:
    # 创建简化的 buildozer.spec
    - |
      cat > buildozer.spec << 'EOF'
      [app]
      title = SmartFarm
      package.name = smartfarm
      package.domain = com.smartfarm.app
      source.dir = .
      source.include_exts = py,png,jpg,kv,atlas
      version = 1.0
      requirements = python3,kivy,kivymd,requests
      orientation = portrait
      
      [buildozer]
      log_level = 2
      warn_on_root = 0
      
      android.permissions = INTERNET,ACCESS_NETWORK_STATE
      android.api = 33
      android.minapi = 21
      android.archs = arm64-v8a
      android.accept_sdk_license = True
      EOF
    
    # 显示环境信息
    - echo "=== Environment Information ==="
    - echo "Buildozer version: $(buildozer --version)"
    - echo "Python version: $(python3 --version)"
    - echo "Android SDK: $ANDROID_SDK_ROOT"
    - echo "Android NDK: $ANDROID_NDK_ROOT"
    
    # 构建 APK
    - echo "=== Starting APK Build ==="
    - buildozer android debug -v
    
    # 检查构建结果
    - echo "=== Build Results ==="
    - ls -la bin/ || echo "No bin directory"
    - find . -name "*.apk" -exec ls -lh {} \; || echo "No APK found"
    
  artifacts:
    paths:
      - bin/*.apk
      - "*.apk"
    expire_in: 1 week
    when: always
    
  cache:
    paths:
      - .buildozer/
    key: kivy-docker-cache-v1