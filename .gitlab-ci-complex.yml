# GitLab CI/CD 配置文件 - 智慧农场 Android App (Docker 优化版)
stages:
  - build

variables:
  ANDROID_COMPILE_SDK: "33"
  ANDROID_BUILD_TOOLS: "33.0.0"
  PYTHON_VERSION: "3.9"

build_android_docker:
  stage: build
  # 使用专门的 Android 构建镜像
  image: cimg/android:2023.12
  timeout: 2h
  
  before_script:
    # 安装 Python 和依赖
    - sudo apt-get update -qq
    - sudo apt-get install -y -qq python3 python3-pip python3-venv python3-dev
    - sudo apt-get install -y -qq build-essential libssl-dev libffi-dev
    - sudo apt-get install -y -qq autoconf libtool pkg-config zlib1g-dev
    - sudo apt-get install -y -qq libncurses5-dev libncursesw5-dev libtinfo5
    
    # 设置 Python 环境
    - python3 --version
    - python3 -m pip install --upgrade pip --user
    - pip3 install buildozer cython --user
    - pip3 install -r requirements.txt --user
    
    # 设置环境变量
    - export PATH=$PATH:~/.local/bin
    - export BUILDOZER_WARN_ON_ROOT=0
    
  script:
    # 显示环境信息
    - echo "=== Environment Information ==="
    - echo "ANDROID_HOME: $ANDROID_HOME"
    - echo "ANDROID_SDK_ROOT: $ANDROID_SDK_ROOT"
    - echo "Java version: $(java -version 2>&1 | head -1)"
    - echo "Python version: $(python3 --version)"
    - which buildozer
    - buildozer --version
    
    # 优化 buildozer.spec
    - sed -i 's/android.archs = arm64-v8a, armeabi-v7a/android.archs = arm64-v8a/' buildozer.spec
    - sed -i 's/requirements = python3,kivy,kivymd,requests,urllib3,certifi,charset-normalizer,idna/requirements = python3,kivy,kivymd,requests/' buildozer.spec
    
    # 构建 APK
    - echo "=== Starting APK Build ==="
    - buildozer android debug -v
    
    # 检查构建结果
    - echo "=== Build Results ==="
    - ls -la bin/ || echo "No bin directory found"
    - find . -name "*.apk" -type f -exec ls -lh {} \; || echo "No APK files found"
    
  artifacts:
    paths:
      - bin/*.apk
    expire_in: 1 week
    when: always
    
  cache:
    key: buildozer-docker-cache-v1
    paths:
      - .buildozer/
    policy: pull-push