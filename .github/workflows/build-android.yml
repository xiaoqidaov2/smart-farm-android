# GitHub Actions é…ç½®æ–‡ä»¶ - æ™ºæ…§å†œåœº Android App
name: Build Android APK

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ created ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: â˜• Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: ğŸ“¦ Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: ğŸ’¾ Cache Android SDK
      uses: actions/cache@v3
      with:
        path: |
          ~/.android/sdk
          ~/.buildozer
        key: ${{ runner.os }}-android-${{ hashFiles('buildozer.spec') }}
        restore-keys: |
          ${{ runner.os }}-android-
          
    - name: ğŸ”§ Install system dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          build-essential libssl-dev libffi-dev python3-dev \
          autoconf libtool pkg-config zlib1g-dev libncurses5-dev \
          libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev \
          git wget curl unzip
          
    - name: ğŸ Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython
        pip install -r requirements.txt
        
    - name: ğŸ“± Install Android SDK
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡
        export ANDROID_SDK_TOOLS=9477386
        export ANDROID_COMPILE_SDK=33
        export ANDROID_BUILD_TOOLS=33.0.0
        
        # ä¸‹è½½å¹¶å®‰è£… Android SDK
        wget --quiet --output-document=android-sdk.zip \
          https://dl.google.com/android/repository/commandlinetools-linux-${ANDROID_SDK_TOOLS}_latest.zip
        unzip -q android-sdk.zip -d $HOME/android-sdk-linux
        
        # è®¾ç½® SDK è·¯å¾„
        export ANDROID_SDK_ROOT=$HOME/android-sdk-linux
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export PATH=$PATH:${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools
        
        # åˆ›å»ºç›®å½•ç»“æ„
        mkdir -p ${ANDROID_SDK_ROOT}/cmdline-tools/latest
        mv ${ANDROID_SDK_ROOT}/cmdline-tools/* ${ANDROID_SDK_ROOT}/cmdline-tools/latest/ 2>/dev/null || true
        
        # æ¥å—è®¸å¯è¯å¹¶å®‰è£…ç»„ä»¶
        yes | ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --licenses >/dev/null 2>&1 || true
        ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager \
          "platforms;android-${ANDROID_COMPILE_SDK}" \
          "build-tools;${ANDROID_BUILD_TOOLS}" \
          "ndk;25.2.9519653"
        
        # è®¾ç½®ç¯å¢ƒå˜é‡åˆ° GitHub Actions
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/25.2.9519653" >> $GITHUB_ENV
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
        
    - name: ğŸ”¨ Build APK with Buildozer
      run: |
        # ç¡®ä¿ buildozer.spec å­˜åœ¨
        if [ ! -f buildozer.spec ]; then
          buildozer init
        fi
        
        # æ„å»º APK
        buildozer android debug
        
    - name: ğŸ“‹ List build artifacts
      run: |
        echo "=== Build artifacts ==="
        find . -name "*.apk" -type f
        ls -la bin/ || echo "No bin directory found"
        
    - name: ğŸ“¤ Upload APK artifact
      uses: actions/upload-artifact@v3
      with:
        name: android-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: ğŸ·ï¸ Upload APK to Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: bin/*.apk
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # å¯é€‰ï¼šéƒ¨ç½²åˆ° GitHub Pages
  deploy-pages:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
      
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download APK artifact
      uses: actions/download-artifact@v3
      with:
        name: android-apk
        path: ./apk
        
    - name: ğŸ“„ Create download page
      run: |
        mkdir -p public
        cp -r apk/* public/ 2>/dev/null || echo "No APK files to copy"
        
        # åˆ›å»ºç®€å•çš„ä¸‹è½½é¡µé¢
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>æ™ºæ…§å†œåœº Android App</title>
            <style>
                body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
                .header { text-align: center; margin-bottom: 30px; }
                .download-section { background: #f5f5f5; padding: 20px; border-radius: 8px; }
                .apk-link { display: inline-block; background: #007cba; color: white; padding: 12px 24px; 
                           text-decoration: none; border-radius: 4px; margin: 10px 0; }
                .apk-link:hover { background: #005a87; }
                .info { margin-top: 20px; color: #666; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ğŸŒ± æ™ºæ…§å†œåœº Android App</h1>
                <p>åŸºäº Python KivyMD å¼€å‘çš„æ™ºæ…§å†œåœºç›‘æ§åº”ç”¨</p>
            </div>
            
            <div class="download-section">
                <h2>ğŸ“± ä¸‹è½½ APK</h2>
        EOF
        
        # æ·»åŠ  APK ä¸‹è½½é“¾æ¥
        for apk in public/*.apk; do
          if [ -f "$apk" ]; then
            filename=$(basename "$apk")
            echo "        <a href=\"$filename\" class=\"apk-link\">ğŸ“¥ ä¸‹è½½ $filename</a><br>" >> public/index.html
          fi
        done
        
        cat >> public/index.html << 'EOF'
            </div>
            
            <div class="info">
                <h3>ğŸ“‹ å®‰è£…è¯´æ˜</h3>
                <ol>
                    <li>ä¸‹è½½ APK æ–‡ä»¶åˆ° Android è®¾å¤‡</li>
                    <li>åœ¨è®¾ç½®ä¸­å…è®¸å®‰è£…æœªçŸ¥æ¥æºåº”ç”¨</li>
                    <li>ç‚¹å‡» APK æ–‡ä»¶è¿›è¡Œå®‰è£…</li>
                    <li>æ‰“å¼€åº”ç”¨ï¼Œè¾“å…¥ NLECloud è´¦å·ä¿¡æ¯</li>
                </ol>
                
                <h3>ğŸ”§ ç³»ç»Ÿè¦æ±‚</h3>
                <ul>
                    <li>Android 5.0 (API 21) æˆ–æ›´é«˜ç‰ˆæœ¬</li>
                    <li>ARM64 æˆ– ARMv7 æ¶æ„</li>
                    <li>ç½‘ç»œè¿æ¥</li>
                </ul>
                
                <p><strong>æ„å»ºæ—¶é—´:</strong> $(date)</p>
                <p><strong>GitHub:</strong> <a href="https://github.com/${{ github.repository }}">æŸ¥çœ‹æºä»£ç </a></p>
            </div>
        </body>
        </html>
        EOF
        
    - name: ğŸ”§ Setup Pages
      uses: actions/configure-pages@v3
      
    - name: ğŸ“¤ Upload to Pages
      uses: actions/upload-pages-artifact@v2
      with:
        path: ./public
        
    - name: ğŸš€ Deploy to Pages
      id: deployment
      uses: actions/deploy-pages@v2